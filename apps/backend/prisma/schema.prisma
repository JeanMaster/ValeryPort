// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo inicial de Usuario
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Client {
  id            String   @id // Will be manually set as "V-12345678"
  name          String
  address       String?
  phone         String?
  hasWhatsapp   Boolean  @default(false)
  email         String?

  social1       String?
  social2       String?
  social3       String?

  // Ventas asociadas
  sales         Sale[]
  invoices      Invoice[]

  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("clients")
}

model Supplier {
  id            String   @id @default(uuid())
  rif           String   @unique
  comercialName String
  legalName     String?
  contactName   String?
  address       String?
  phone         String?
  email         String?
  category      String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Compras asociadas
  purchases     Purchase[]

  @@map("suppliers")
}

model Purchase {
  id              String   @id @default(uuid())
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  invoiceDate     DateTime // Fecha de la factura del proveedor
  invoiceNumber   String?  // Número de control/factura del proveedor
  
  subtotal        Decimal  @db.Decimal(10, 2)
  taxAmount       Decimal  @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(10, 2)
  
  currencyCode    String   @default("VES") // Moneda de la compra (usualmente la del sistema)
  exchangeRate    Decimal  @default(1.0)   @db.Decimal(10, 4)
  
  status          String   @default("COMPLETED") // PENDING, COMPLETED, CANCELLED
  
  items           PurchaseItem[]
  
  userId          String?  // Usuario que registró la compra
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("purchases")
}

model PurchaseItem {
  id              String   @id @default(uuid())
  purchaseId      String
  purchase        Purchase @relation(fields: [purchaseId], references: [id])
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  quantity        Decimal  @db.Decimal(10, 3)
  cost            Decimal  @db.Decimal(10, 2) // Costo unitario al que se compró
  total           Decimal  @db.Decimal(10, 2) // quantity * cost
  
  oldCost         Decimal? @db.Decimal(10, 2) // Referencia del costo anterior
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("purchase_items")
}

model Product {
  id              String      @id @default(uuid())
  sku             String      @unique
  name            String
  description     String?
  
  // Categorías (relaciones con Department)
  categoryId      String
  category        Department  @relation("ProductCategory", fields: [categoryId], references: [id])
  subcategoryId   String?
  subcategory     Department? @relation("ProductSubcategory", fields: [subcategoryId], references: [id])
  
  // Moneda
  currencyId      String
  currency        Currency    @relation(fields: [currencyId], references: [id])
  
  // Precios (en la moneda seleccionada)
  costPrice       Decimal     @db.Decimal(10, 2)
  salePrice       Decimal     @db.Decimal(10, 2)
  offerPrice      Decimal?    @db.Decimal(10, 2)
  wholesalePrice  Decimal?    @db.Decimal(10, 2)
  
  // Inventario
  stock           Int         @default(0)
  
  // Unidad principal (obligatoria)
  unitId          String
  unit            Unit        @relation("ProductPrimaryUnit", fields: [unitId], references: [id])
  
  // Unidad secundaria (opcional - ej: caja, paquete)
  secondaryUnitId       String?
  secondaryUnit         Unit?   @relation("ProductSecondaryUnit", fields: [secondaryUnitId], references: [id])
  unitsPerSecondaryUnit Int?    // Cantidad para conversión
  conversionDirection   String? // "primary_to_secondary" o "secondary_to_primary"
  
  // Precios para unidad secundaria
  secondaryCostPrice      Decimal? @db.Decimal(10, 2)
  secondarySalePrice      Decimal? @db.Decimal(10, 2)
  secondaryOfferPrice     Decimal? @db.Decimal(10, 2)
  secondaryWholesalePrice Decimal? @db.Decimal(10, 2)

  // Items de venta asociados
  saleItems      SaleItem[]

  // Política de devoluciones
  isReturnable         Boolean  @default(true)
  returnDeadlineDays   Int?     // null = usar default global (30)

  // Relaciones con devoluciones
  returnItems          ReturnItem[]
  
  // Relación con ajustes de inventario
  adjustments InventoryAdjustment[]
  
  // Relación con items de compra
  purchaseItems PurchaseItem[]

  active          Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("products")
}

model CompanySettings {
  id        String   @id @default(uuid())
  name      String
  rif       String
  logoUrl   String?
  
  preferredSecondaryCurrencyId String?
  preferredSecondaryCurrency   Currency? @relation(fields: [preferredSecondaryCurrencyId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_settings")
}

model Department {
  id          String       @id @default(uuid())
  name        String
  description String?
  parentId    String?
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Department[] @relation("DepartmentHierarchy")
  
  // Productos usando este departamento
  productsAsCategory    Product[] @relation("ProductCategory")
  productsAsSubcategory Product[] @relation("ProductSubcategory")
  
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("departments")
}

model Unit {
  id           String   @id @default(uuid())
  name         String   @unique
  abbreviation String
  
  // Productos usando esta unidad
  productsAsPrimary   Product[] @relation("ProductPrimaryUnit")
  productsAsSecondary Product[] @relation("ProductSecondaryUnit")
  
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("units")
}

model Currency {
  id           String   @id @default(uuid())
  name         String   @unique
  code         String   @unique
  symbol       String
  isPrimary    Boolean  @default(false)
  exchangeRate Decimal? @db.Decimal(10, 4)

  // Productos en esta moneda
  products     Product[]

  // Configuraciones que usan esta moneda
  companySettings CompanySettings[]

  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("currencies")
}

model Sale {
  id            String     @id @default(uuid())
  date          DateTime   @default(now())
  invoiceNumber String     @unique

  // Cliente (opcional para ventas walk-in)
  clientId      String?
  client        Client?    @relation(fields: [clientId], references: [id])

  // Totales
  subtotal      Decimal    @db.Decimal(10, 2)
  discount      Decimal    @db.Decimal(10, 2) @default(0)
  tax           Decimal    @db.Decimal(10, 2) @default(0)
  total         Decimal    @db.Decimal(10, 2)

  // Pago
  paymentMethod String     // CASH, DEBIT, CREDIT, etc.
  tendered      Decimal?   @db.Decimal(10, 2)
  change        Decimal?   @db.Decimal(10, 2)

  // Items de la venta
  items         SaleItem[]

  // Relaciones con devoluciones
  returns           Return[] @relation("OriginalSale")
  replacementReturns Return[] @relation("ReturnNewSale")

  // Estado
  hasReturns        Boolean  @default(false)
  isCancelled       Boolean  @default(false)

  // Relaciones con caja
  cashMovements     CashMovement[]
  
  // Factura asociada (para ventas a crédito)
  invoice           Invoice?
  
  // Caja
  cashSessionId     String?
  cashSession       CashSession? @relation(fields: [cashSessionId], references: [id])

  active        Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@map("sales")
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Decimal @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sale_items")
}

model InvoiceCounter {
  id        String   @id @default(uuid())
  prefix    String   @default("FAC")
  currentNumber Int   @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoice_counters")
}

model Invoice {
  id              String   @id @default(uuid())
  number          String   @unique
  
  // Cliente
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])
  
  // Venta relacionada (opcional, si viene de POS)
  saleId          String?  @unique
  sale            Sale?    @relation(fields: [saleId], references: [id])
  
  // Montos
  subtotal        Decimal  @db.Decimal(10, 2)
  discount        Decimal  @db.Decimal(10, 2) @default(0)
  tax             Decimal  @db.Decimal(10, 2) @default(0)
  total           Decimal  @db.Decimal(10, 2)
  
  // Control de crédito
  status          String   @default("PENDING") // PENDING, PARTIAL, PAID, OVERDUE, CANCELLED
  dueDate         DateTime?
  paidAmount      Decimal  @db.Decimal(10, 2) @default(0)
  balance         Decimal  @db.Decimal(10, 2) // total - paidAmount
  
  // Pagos relacionados
  payments        Payment[]
  
  // Notas
  notes           String?
  
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("invoices")
}

model Payment {
  id              String   @id @default(uuid())
  
  // Factura a la que se aplica el pago
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id])
  
  // Detalles del pago
  amount          Decimal  @db.Decimal(10, 2)
  paymentDate     DateTime @default(now())
  paymentMethod   String   // CASH, DEBIT, CREDIT, TRANSFER, MOBILE, ZELLE, etc
  reference       String?  // Número de referencia bancaria
  notes           String?
  
  // Auditoría (para futuro)
  createdBy       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("payments")
}


model Return {
  id                String   @id @default(uuid())
  
  // Referencias
  originalSaleId    String
  originalSale      Sale     @relation("OriginalSale", fields: [originalSaleId], references: [id])
  creditNoteNumber  String   @unique
  
  // Tipo y motivo
  returnType        String   // "REFUND", "EXCHANGE_SAME", "EXCHANGE_DIFFERENT"
  reason            String   // "DEFECTIVE", "UNSATISFIED", "ERROR", "EXPIRED", "OTHER"
  productCondition  String   // "EXCELLENT", "GOOD", "DEFECTIVE", "DAMAGED"
  
  // Items devueltos
  items             ReturnItem[]
  
  // Financiero
  refundAmount      Decimal  @db.Decimal(10, 2)
  refundMethod      String?  // "CASH", "TRANSFER", "CREDIT_NOTE"
  
  // Nueva venta (si es cambio)
  newSaleId         String?
  newSale           Sale?    @relation("ReturnNewSale", fields: [newSaleId], references: [id])
  
  // Workflow
  status            String   @default("PENDING") // "PENDING", "APPROVED", "REJECTED", "COMPLETED"
  requestedBy       String?
  approvedBy        String?
  approvedAt        DateTime?
  
  // Notas
  notes             String?
  
  // Auditoría
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("returns")
}

model ReturnItem {
  id               String  @id @default(uuid())
  returnId         String
  return           Return  @relation(fields: [returnId], references: [id], onDelete: Cascade)
  
  productId        String
  product          Product @relation(fields: [productId], references: [id])
  
  quantity         Int
  unitPrice        Decimal @db.Decimal(10, 2)
  total            Decimal @db.Decimal(10, 2)
  
  restockQuantity  Int     @default(0) // Cantidad que se regresa al stock
  
  @@map("return_items")
}

model CashRegister {
  id          String        @id @default(uuid())
  name        String        // "Caja Principal", "Caja 2"
  location    String?       // "Tienda", "Almacén"
  isActive    Boolean       @default(true)
  sessions    CashSession[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@map("cash_registers")
}

model CashSession {
  id                String         @id @default(uuid())
  registerId        String
  register          CashRegister   @relation(fields: [registerId], references: [id])
  
  // Session info
  openedBy          String         // Usuario que abre
  closedBy          String?        // Usuario que cierra
  openedAt          DateTime       @default(now())
  closedAt          DateTime?
  status            String         @default("OPEN") // OPEN, CLOSED
  
  // Opening balance
  openingBalance    Decimal        @db.Decimal(10, 2)
  openingNotes      String?
  
  // Closing info
  expectedBalance   Decimal?       @db.Decimal(10, 2)
  actualBalance     Decimal?       @db.Decimal(10, 2)
  variance          Decimal?       @db.Decimal(10, 2) // actualBalance - expectedBalance
  closingNotes      String?
  
  // Movements during session
  movements         CashMovement[]
  sales             Sale[]
  
  active            Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@map("cash_sessions")
}

model CashMovement {
  id              String       @id @default(uuid())
  sessionId       String
  session         CashSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Movement details
  type            String       // "SALE", "EXPENSE", "DEPOSIT", "WITHDRAWAL", "OPENING", "CLOSING"
  amount          Decimal      @db.Decimal(10, 2)
  currencyCode    String       @default("VES") // VES, USD, EUR, etc.
  
  // References
  saleId          String?      // Si es de una venta
  sale            Sale?        @relation(fields: [saleId], references: [id])
  
  // Description
  description     String
  notes           String?
  performedBy     String       // Usuario que realiza
  
  createdAt       DateTime     @default(now())
  
  @@map("cash_movements")
}

model InventoryAdjustment {
  id            String   @id @default(uuid())
  
  // Product reference
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  
  // Adjustment details
  type          String   // "INCREASE" or "DECREASE"
  quantity      Int      // Absolute value
  previousStock Int      // Stock before adjustment
  newStock      Int      // Stock after adjustment
  
  // Reason and context
  reason        String   // "DAMAGE", "LOSS", "ERROR", "INITIAL", "RETURN", "OTHER"
  notes         String?  // Explanation
  
  // User tracking
  performedBy   String   // Usuario que realiza
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  @@map("inventory_adjustments")
}
