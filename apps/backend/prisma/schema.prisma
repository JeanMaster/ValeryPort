// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo inicial de Usuario
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Client {
  id            String   @id // Will be manually set as "V-12345678"
  name          String
  address       String?
  phone         String?
  hasWhatsapp   Boolean  @default(false)
  email         String?

  social1       String?
  social2       String?
  social3       String?

  // Ventas asociadas
  sales         Sale[]

  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("clients")
}

model Supplier {
  id            String   @id @default(uuid())
  rif           String   @unique
  comercialName String
  legalName     String?
  contactName   String?
  address       String?
  phone         String?
  email         String?
  category      String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("suppliers")
}

model Product {
  id              String      @id @default(uuid())
  sku             String      @unique
  name            String
  description     String?
  
  // Categorías (relaciones con Department)
  categoryId      String
  category        Department  @relation("ProductCategory", fields: [categoryId], references: [id])
  subcategoryId   String?
  subcategory     Department? @relation("ProductSubcategory", fields: [subcategoryId], references: [id])
  
  // Moneda
  currencyId      String
  currency        Currency    @relation(fields: [currencyId], references: [id])
  
  // Precios (en la moneda seleccionada)
  costPrice       Decimal     @db.Decimal(10, 2)
  salePrice       Decimal     @db.Decimal(10, 2)
  offerPrice      Decimal?    @db.Decimal(10, 2)
  wholesalePrice  Decimal?    @db.Decimal(10, 2)
  
  // Inventario
  stock           Int         @default(0)
  
  // Unidad principal (obligatoria)
  unitId          String
  unit            Unit        @relation("ProductPrimaryUnit", fields: [unitId], references: [id])
  
  // Unidad secundaria (opcional - ej: caja, paquete)
  secondaryUnitId       String?
  secondaryUnit         Unit?   @relation("ProductSecondaryUnit", fields: [secondaryUnitId], references: [id])
  unitsPerSecondaryUnit Int?    // Cantidad para conversión
  conversionDirection   String? // "primary_to_secondary" o "secondary_to_primary"
  
  // Precios para unidad secundaria
  secondaryCostPrice      Decimal? @db.Decimal(10, 2)
  secondarySalePrice      Decimal? @db.Decimal(10, 2)
  secondaryOfferPrice     Decimal? @db.Decimal(10, 2)
  secondaryWholesalePrice Decimal? @db.Decimal(10, 2)

  // Items de venta asociados
  saleItems      SaleItem[]

  active          Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("products")
}

model CompanySettings {
  id        String   @id @default(uuid())
  name      String
  rif       String
  logoUrl   String?
  
  preferredSecondaryCurrencyId String?
  preferredSecondaryCurrency   Currency? @relation(fields: [preferredSecondaryCurrencyId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_settings")
}

model Department {
  id          String       @id @default(uuid())
  name        String
  description String?
  parentId    String?
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Department[] @relation("DepartmentHierarchy")
  
  // Productos usando este departamento
  productsAsCategory    Product[] @relation("ProductCategory")
  productsAsSubcategory Product[] @relation("ProductSubcategory")
  
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("departments")
}

model Unit {
  id           String   @id @default(uuid())
  name         String   @unique
  abbreviation String
  
  // Productos usando esta unidad
  productsAsPrimary   Product[] @relation("ProductPrimaryUnit")
  productsAsSecondary Product[] @relation("ProductSecondaryUnit")
  
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("units")
}

model Currency {
  id           String   @id @default(uuid())
  name         String   @unique
  code         String   @unique
  symbol       String
  isPrimary    Boolean  @default(false)
  exchangeRate Decimal? @db.Decimal(10, 4)

  // Productos en esta moneda
  products     Product[]

  // Configuraciones que usan esta moneda
  companySettings CompanySettings[]

  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("currencies")
}

model Sale {
  id            String     @id @default(uuid())
  date          DateTime   @default(now())
  invoiceNumber String     @unique

  // Cliente (opcional para ventas walk-in)
  clientId      String?
  client        Client?    @relation(fields: [clientId], references: [id])

  // Totales
  subtotal      Decimal    @db.Decimal(10, 2)
  discount      Decimal    @db.Decimal(10, 2) @default(0)
  tax           Decimal    @db.Decimal(10, 2) @default(0)
  total         Decimal    @db.Decimal(10, 2)

  // Pago
  paymentMethod String     // CASH, DEBIT, CREDIT, etc.
  tendered      Decimal?   @db.Decimal(10, 2)
  change        Decimal?   @db.Decimal(10, 2)

  // Items de la venta
  items         SaleItem[]

  active        Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@map("sales")
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Decimal @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sale_items")
}

model InvoiceCounter {
  id        String   @id @default(uuid())
  prefix    String   @default("FAC")
  currentNumber Int   @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoice_counters")
}
